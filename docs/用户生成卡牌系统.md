# 用户生成卡牌系统

## 概述

卡牌系统采用统一的卡牌池设计，所有独特的卡牌（包括基础卡牌和用户生成卡牌）都存储在 `cards` 表中，用户背包通过卡牌ID引用卡牌。

## 数据库设计

### cards 表

所有卡牌的主表，包含基础卡牌和用户生成卡牌。

**新增字段：**
- `is_base_card` (BOOLEAN): 标识是否为初始基础卡牌，默认 TRUE
- `created_by_user_id` (INTEGER): 创建该卡牌的用户ID，仅用户生成卡牌有值
- `source_type` (VARCHAR): 卡牌来源类型
  - `base` - 基础卡牌（预设）
  - `user_generated` - 用户合成生成
  - `ai_generated` - AI生成

### deck_cards 表

用户背包表，存储用户拥有的卡牌引用。

**字段：**
- `user_id` - 用户ID
- `card_id` - 卡牌ID（外键引用 cards.id）
- `discovered` - 是否已发现
- `count` - 拥有数量

## 工作流程

### 1. 用户合成新卡牌

当用户合成一张新卡牌时：

1. **检查卡牌是否存在**
   ```sql
   SELECT id FROM cards WHERE name = '新卡牌名称'
   ```

2. **如果不存在，创建新卡牌**
   ```sql
   INSERT INTO cards (
     name, type, rarity, era, card_type, attrs_json,
     is_base_card, created_by_user_id, source_type
   ) VALUES (
     '新卡牌', 'inspiration', 'common', '生存时代', 'inspiration', '{}',
     FALSE, 用户ID, 'user_generated'
   )
   ```

3. **添加到用户背包**
   ```sql
   INSERT INTO deck_cards (user_id, card_id, discovered, count)
   VALUES (用户ID, 卡牌ID, TRUE, 1)
   ON CONFLICT (user_id, card_id)
   DO UPDATE SET count = deck_cards.count + 1
   ```

### 2. 其他用户合成相同卡牌

如果其他用户合成了同名卡牌：
- 直接使用已存在的卡牌ID
- 添加到该用户的背包中
- 计数器 +1

这样保证：
- **卡牌池是全局共享的**
- **每个独特的卡牌只有一个记录**
- **用户只存储卡牌引用和数量**

## API 服务

### cardService.js

**创建或获取用户卡牌：**
```javascript
createOrGetUserCard(userId, cardData)
```

- 自动检查卡牌是否存在
- 不存在则创建，存在则复用
- 自动添加到用户背包

**获取用户创建的卡牌：**
```javascript
getUserCreatedCards(userId)
```

**获取基础卡牌：**
```javascript
getBaseCards()
```

**获取所有用户生成卡牌：**
```javascript
getAllUserGeneratedCards(limit, offset)
```

## 管理界面

### /cardsdatabase/ 路由

管理员专用的卡牌数据库管理界面，功能包括：

1. **查看所有卡牌**
   - 基础卡牌（绿色标记）
   - 用户生成卡牌（蓝色标记）

2. **筛选功能**
   - 按来源：全部 / 基础卡牌 / 用户生成
   - 按时代：生存时代、城邦时代等
   - 按类型：钥匙卡、灵感卡、奖励卡

3. **统计信息**
   - 基础卡牌数量
   - 用户生成卡牌数量
   - 总计

4. **管理操作**
   - 创建新基础卡牌
   - 编辑卡牌信息
   - 删除卡牌（用户生成卡牌受保护）

## 数据库迁移

### 运行迁移

```bash
# 方式一：使用 Node.js 脚本
node server/db/run-migration-user-cards.js

# 方式二：直接执行 SQL
sudo -u postgres psql -d minigame < server/db/migrations/add_user_generated_cards.sql
```

### 迁移内容

1. 添加三个新字段到 cards 表
2. 创建相关索引
3. 将现有卡牌标记为基础卡牌

## 时代限制

用户合成卡牌时，系统会自动：
- 根据用户当前时代限制可用卡牌
- 只有解锁相应时代的卡牌才能在合成时使用
- AI 合成会考虑时代限制，避免超时代合成

## 优势

1. **唯一性保证**：每个独特卡牌只有一个数据库记录
2. **全局共享**：所有用户的创意卡牌可以被其他玩家复现
3. **追溯性**：记录了卡牌的创建者
4. **性能优化**：背包只存储ID引用，不重复存储卡牌数据
5. **可扩展性**：支持未来的卡牌交易、图鉴等功能
6. **分离管理**：基础卡牌和用户生成卡牌清晰分离

## 注意事项

1. **删除保护**：用户生成的卡牌应谨慎删除，会影响所有拥有该卡牌的用户
2. **命名唯一性**：卡牌名称是唯一标识，不能重复
3. **时代匹配**：合成时需要验证用户的时代权限
4. **数据完整性**：通过外键约束保证引用完整性


