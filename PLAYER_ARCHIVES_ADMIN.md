# ç©å®¶å­˜æ¡£ç®¡ç†é¢æ¿

## åŠŸèƒ½æ¦‚è¿°

ä¸ºç®¡ç†å‘˜æä¾›ä¸€ä¸ªå®Œæ•´çš„ç©å®¶å­˜æ¡£ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æŸ¥çœ‹ã€æœç´¢ã€åˆ é™¤ç©å®¶å­˜æ¡£æ•°æ®ã€‚

---

## è®¿é—®å…¥å£

### 1. é€šè¿‡å¤§å…è®¾ç½®é¢æ¿

1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
2. ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½®å›¾æ ‡
3. åœ¨è®¾ç½®é¢æ¿ä¸­æ‰¾åˆ° **ğŸ“ ç©å®¶å­˜æ¡£** æŒ‰é’®
4. ç‚¹å‡»æ‰“å¼€ç©å®¶å­˜æ¡£ç®¡ç†é¢æ¿

### 2. æƒé™è¦æ±‚

- å¿…é¡»ä»¥ `role = 'admin'` çš„è´¦å·ç™»å½•
- éç®¡ç†å‘˜ç”¨æˆ·çœ‹ä¸åˆ°æ­¤æŒ‰é’®

---

## åŠŸèƒ½è¯´æ˜

### 1. ç©å®¶åˆ—è¡¨æŸ¥çœ‹

**å·¦ä¾§é¢æ¿æ˜¾ç¤ºï¼š**
- âœ… ç”¨æˆ·å
- âœ… é‚®ç®±åœ°å€
- âœ… å½“å‰æ—¶ä»£
- âœ… å¡ç‰Œæ•°é‡
- âœ… åœ°å—æ ‡å¿—æ•°é‡
- âœ… æ³¨å†Œæ—¶é—´
- âœ… ç®¡ç†å‘˜æ ‡è¯†ï¼ˆå¦‚æœæ˜¯ç®¡ç†å‘˜è´¦å·ï¼‰

### 2. æœç´¢åŠŸèƒ½

**é¡¶éƒ¨æœç´¢æ ï¼š**
- è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±è¿›è¡Œæœç´¢
- æ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼ˆILIKEï¼‰
- æŒ‰ Enter æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®æ‰§è¡Œæœç´¢
- æœç´¢ç»“æœæ”¯æŒåˆ†é¡µ

### 3. é€‰æ‹©å’Œæ‰¹é‡æ“ä½œ

**å¤é€‰æ¡†åŠŸèƒ½ï¼š**
- å•ä¸ªå‹¾é€‰ï¼šç‚¹å‡»ç©å®¶å‰çš„å¤é€‰æ¡†
- å…¨é€‰ï¼šç‚¹å‡»åˆ—è¡¨é¡¶éƒ¨çš„ "å…¨é€‰" å¤é€‰æ¡†
- æ‰¹é‡åˆ é™¤ï¼šé€‰ä¸­å¤šä¸ªç©å®¶åç‚¹å‡» "æ‰¹é‡åˆ é™¤ (N)" æŒ‰é’®

**ä¿æŠ¤æœºåˆ¶ï¼š**
- âŒ ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·
- âš ï¸ åˆ é™¤å‰ä¼šæœ‰ç¡®è®¤å¯¹è¯æ¡†
- âš ï¸ åˆ é™¤æ“ä½œä¸å¯æ¢å¤

### 4. ç©å®¶è¯¦ç»†ä¿¡æ¯

**ç‚¹å‡»ç©å®¶æŸ¥çœ‹è¯¦æƒ…ï¼ˆå³ä¾§é¢æ¿ï¼‰ï¼š**

#### åŸºæœ¬ä¿¡æ¯
- ç”¨æˆ·å
- é‚®ç®±
- è§’è‰²ï¼ˆuser/adminï¼‰
- æ³¨å†Œæ—¶é—´

#### æ¸¸æˆçŠ¶æ€
- å½“å‰æ—¶ä»£
- å·²å®Œæˆçš„Eventsæ•°é‡
- æ¿€æ´»çš„Event ID
- æ‰‹ç‰Œæ•°é‡
- æœ€åæ¸¸ç©æ—¶é—´

#### ç»Ÿè®¡æ•°æ®
- æ€»å¡ç‰Œæ•°é‡
- çµæ„Ÿå¡æ•°é‡
- é’¥åŒ™å¡æ•°é‡
- å¥–åŠ±å¡æ•°é‡
- åœ°å—æ ‡å¿—æ•°é‡
- é«˜äº®åœ°å—æ•°é‡

#### å¡ç‰Œæ”¶è—
- æ˜¾ç¤ºå‰50å¼ å¡ç‰Œ
- æ˜¾ç¤ºå¡ç‰Œåç§°ã€æ•°é‡ã€ç±»å‹
- æŒ‰ç¨€æœ‰åº¦åˆ†é¢œè‰²æ˜¾ç¤º

#### åœ°å—æ ‡å¿—
- æ˜¾ç¤ºå‰20ä¸ªåœ°å—æ ‡å¿—
- æ˜¾ç¤ºåæ ‡ã€æ ‡å¿—ç±»å‹ã€å…³è”äº‹ä»¶

### 5. æ“ä½œæŒ‰é’®

#### é‡ç½®è¿›åº¦
```
åŠŸèƒ½ï¼šæ¸…ç©ºç©å®¶çš„æ¸¸æˆè¿›åº¦ï¼Œä½†ä¿ç•™è´¦å·
åˆ é™¤å†…å®¹ï¼š
  - æ¸¸æˆçŠ¶æ€
  - å¡ç‰Œæ”¶è—ï¼ˆä¿ç•™èµ·å§‹å¡ï¼šäººã€çŸ³å¤´ï¼‰
  - åœ°å—æ ‡å¿—
  - é«˜äº®åœ°å—
  - äº‹ä»¶æ—¥å¿—
  - èµ„æºæ•°æ®
ä¿ç•™å†…å®¹ï¼š
  - è´¦å·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€å¯†ç ï¼‰
  - è§’è‰²ï¼ˆadmin/userï¼‰
```

#### åˆ é™¤å­˜æ¡£
```
åŠŸèƒ½ï¼šå®Œå…¨åˆ é™¤ç©å®¶è´¦å·å’Œæ‰€æœ‰æ•°æ®
åˆ é™¤å†…å®¹ï¼š
  - ç”¨æˆ·è´¦å·
  - æ¸¸æˆçŠ¶æ€
  - å¡ç‰Œæ”¶è—
  - åœ°å—æ ‡å¿—
  - é«˜äº®åœ°å—
  - äº‹ä»¶æ—¥å¿—
  - èµ„æºæ•°æ®
  - æ‰€æœ‰å…³è”æ•°æ®ï¼ˆçº§è”åˆ é™¤ï¼‰
ä¿æŠ¤ï¼š
  - ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·
```

---

## APIç«¯ç‚¹

### 1. è·å–ç©å®¶åˆ—è¡¨
```http
GET /api/player-archives/list?page=1&limit=20&search=keyword
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "players": [
    {
      "id": 1,
      "username": "player1",
      "email": "player1@example.com",
      "role": "user",
      "era": "ç”Ÿå­˜æ—¶ä»£",
      "completedEvents": [1, 2],
      "totalCards": 8,
      "totalMarkers": 3,
      "totalHighlights": 5,
      "createdAt": "2025-01-01T00:00:00.000Z",
      "lastPlayed": "2025-11-01T12:00:00.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8
  }
}
```

### 2. è·å–ç©å®¶è¯¦æƒ…
```http
GET /api/player-archives/{userId}/detail
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "user": {
    "id": 1,
    "username": "player1",
    "email": "player1@example.com",
    "role": "user",
    "createdAt": "2025-01-01T00:00:00.000Z"
  },
  "gameState": {
    "era": "ç”Ÿå­˜æ—¶ä»£",
    "completedEvents": [1, 2],
    "activeEventId": 3,
    "hand": [...],
    "lastPlayed": "2025-11-01T12:00:00.000Z"
  },
  "cards": [...],
  "markers": [...],
  "highlights": [...],
  "statistics": {
    "totalCards": 8,
    "cardsByType": {
      "inspiration": 6,
      "key": 2,
      "reward": 0
    }
  }
}
```

### 3. åˆ é™¤ç©å®¶å­˜æ¡£
```http
DELETE /api/player-archives/{userId}
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "å·²åˆ é™¤ç©å®¶ player1 çš„æ‰€æœ‰å­˜æ¡£æ•°æ®"
}
```

### 4. æ‰¹é‡åˆ é™¤
```http
POST /api/player-archives/batch-delete
Authorization: Bearer {token}
Content-Type: application/json

{
  "userIds": [1, 2, 3]
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "å·²åˆ é™¤ 3 ä¸ªç©å®¶çš„å­˜æ¡£æ•°æ®",
  "deletedUsers": [
    { "id": 1, "username": "player1", "email": "player1@example.com" },
    { "id": 2, "username": "player2", "email": "player2@example.com" },
    { "id": 3, "username": "player3", "email": "player3@example.com" }
  ]
}
```

### 5. é‡ç½®ç©å®¶è¿›åº¦
```http
POST /api/player-archives/{userId}/reset
Authorization: Bearer {token}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "ç©å®¶æ¸¸æˆè¿›åº¦å·²é‡ç½®ï¼Œè´¦å·ä¿ç•™"
}
```

---

## å®‰å…¨æœºåˆ¶

### 1. æƒé™éªŒè¯

**ä¸­é—´ä»¶é“¾ï¼š**
```javascript
authMiddleware â†’ adminMiddleware
```

- `authMiddleware`: éªŒè¯ JWT token
- `adminMiddleware`: æ£€æŸ¥ `role = 'admin'`

### 2. ç®¡ç†å‘˜ä¿æŠ¤

**ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦å·ï¼š**
```sql
-- åˆ é™¤æ—¶è‡ªåŠ¨æ’é™¤ç®¡ç†å‘˜
DELETE FROM users 
WHERE id = $1 AND role != 'admin'
```

### 3. çº§è”åˆ é™¤

**è‡ªåŠ¨æ¸…ç†å…³è”æ•°æ®ï¼š**
```sql
-- users è¡¨çš„å¤–é”®éƒ½è®¾ç½®äº† ON DELETE CASCADE
deck_cards (user_id) â†’ CASCADE
user_game_state (user_id) â†’ CASCADE
tile_markers (user_id) â†’ CASCADE
highlighted_tiles (user_id) â†’ CASCADE
events_log (user_id) â†’ CASCADE
resources (user_id) â†’ CASCADE
```

### 4. æ“ä½œæ—¥å¿—

**æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•åˆ°æ—¥å¿—ï¼š**
```javascript
logger.info({ 
  userId, 
  username, 
  deletedBy: adminId 
}, 'Player archive deleted');
```

---

## æ•°æ®åº“å½±å“

### åˆ é™¤ç©å®¶æ—¶æ¸…ç†çš„è¡¨

1. **users** - ç”¨æˆ·è´¦å·
2. **deck_cards** - å¡ç‰Œæ”¶è—
3. **user_game_state** - æ¸¸æˆçŠ¶æ€
4. **tile_markers** - åœ°å—æ ‡å¿—
5. **highlighted_tiles** - é«˜äº®åœ°å—
6. **events_log** - äº‹ä»¶æ—¥å¿—
7. **resources** - èµ„æºæ•°æ®
8. **inventories** - èƒŒåŒ…ï¼ˆå¦‚æœæœ‰ï¼‰
9. **world_tiles** - ä¸–ç•Œåœ°å—ï¼ˆå¦‚æœæœ‰ï¼‰
10. **entities** - å®ä½“ï¼ˆå¦‚æœæœ‰ï¼‰
11. **projects** - é¡¹ç›®ï¼ˆå¦‚æœæœ‰ï¼‰

### é‡ç½®è¿›åº¦æ—¶ä¿ç•™çš„æ•°æ®

âœ… **ä¿ç•™ï¼š**
- users è¡¨çš„è´¦å·ä¿¡æ¯

âŒ **æ¸…ç©ºï¼š**
- user_game_state
- deck_cardsï¼ˆé™¤èµ·å§‹å¡ï¼‰
- tile_markers
- highlighted_tiles
- events_log
- resources

---

## ä½¿ç”¨åœºæ™¯

### 1. æ¸…ç†æµ‹è¯•è´¦å·

```
1. æœç´¢ "test"
2. å…¨é€‰æ‰€æœ‰æµ‹è¯•è´¦å·
3. æ‰¹é‡åˆ é™¤
```

### 2. å¤„ç†é—®é¢˜è´¦å·

```
1. æ‰¾åˆ°å‡ºé—®é¢˜çš„ç©å®¶
2. æŸ¥çœ‹è¯¦ç»†æ•°æ®ï¼Œå®šä½é—®é¢˜
3. é€‰æ‹©ï¼š
   - é‡ç½®è¿›åº¦ï¼ˆæ•°æ®æŸåï¼‰
   - åˆ é™¤å­˜æ¡£ï¼ˆä¸¥é‡è¿è§„ï¼‰
```

### 3. æ•°æ®åˆ†æ

```
1. æŸ¥çœ‹ç©å®¶è¿›åº¦åˆ†å¸ƒ
2. ç»Ÿè®¡å¡ç‰Œæ”¶è—æƒ…å†µ
3. åˆ†ææ¸¸æˆè¡Œä¸º
```

### 4. ç”¨æˆ·æ”¯æŒ

```
ç©å®¶è¯·æ±‚ï¼š
  - "æˆ‘æƒ³é‡æ–°å¼€å§‹" â†’ é‡ç½®è¿›åº¦
  - "åˆ é™¤æˆ‘çš„è´¦å·" â†’ åˆ é™¤å­˜æ¡£
```

---

## å‰ç«¯ç»„ä»¶

### PlayerArchivesPanel.jsx

**ä½ç½®ï¼š** `client/src/components/admin/PlayerArchivesPanel.jsx`

**Propsï¼š**
```javascript
{
  token: string,      // JWT token
  onClose: function   // å…³é—­é¢æ¿çš„å›è°ƒ
}
```

**Stateç®¡ç†ï¼š**
```javascript
- players: ç©å®¶åˆ—è¡¨
- selectedPlayer: é€‰ä¸­çš„ç©å®¶ID
- playerDetail: ç©å®¶è¯¦æƒ…æ•°æ®
- page: å½“å‰é¡µç 
- search: æœç´¢å…³é”®è¯
- selectedIds: é€‰ä¸­çš„ç©å®¶IDé›†åˆ
- loading: åŠ è½½çŠ¶æ€
- error: é”™è¯¯ä¿¡æ¯
```

---

## æ ·å¼

**æ–‡ä»¶ï¼š** `client/src/styles/playerArchivesPanel.css`

**ç‰¹ç‚¹ï¼š**
- å…¨å±æ¨¡æ€çª—å£
- å·¦å³åˆ†æ å¸ƒå±€
- ç´«è‰²æ¸å˜ä¸»é¢˜
- å“åº”å¼æ»šåŠ¨
- æ‚¬åœé«˜äº®æ•ˆæœ

---

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

- [ ] ç®¡ç†å‘˜èƒ½çœ‹åˆ° "ç©å®¶å­˜æ¡£" æŒ‰é’®
- [ ] æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°æ­¤æŒ‰é’®
- [ ] ç©å®¶åˆ—è¡¨æ­£ç¡®åŠ è½½
- [ ] æœç´¢åŠŸèƒ½æ­£å¸¸
- [ ] åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- [ ] å…¨é€‰/å•é€‰åŠŸèƒ½æ­£å¸¸
- [ ] æ‰¹é‡åˆ é™¤åŠŸèƒ½æ­£å¸¸
- [ ] æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½æ­£å¸¸
- [ ] é‡ç½®è¿›åº¦åŠŸèƒ½æ­£å¸¸
- [ ] åˆ é™¤å­˜æ¡£åŠŸèƒ½æ­£å¸¸

### å®‰å…¨æµ‹è¯•

- [ ] éç®¡ç†å‘˜æ— æ³•è®¿é—®API
- [ ] æ— æ³•åˆ é™¤ç®¡ç†å‘˜è´¦å·
- [ ] æ‰¹é‡åˆ é™¤æ—¶è‡ªåŠ¨è¿‡æ»¤ç®¡ç†å‘˜
- [ ] åˆ é™¤å‰æœ‰ç¡®è®¤å¯¹è¯æ¡†

### è¾¹ç•Œæµ‹è¯•

- [ ] 0ä¸ªç©å®¶æ—¶æ˜¾ç¤ºæ­£å¸¸
- [ ] æœç´¢æ— ç»“æœæ—¶æ˜¾ç¤ºæ­£å¸¸
- [ ] å¤§é‡ç©å®¶æ—¶æ€§èƒ½æ­£å¸¸
- [ ] é•¿ç”¨æˆ·å/é‚®ç®±æ­£ç¡®æˆªæ–­

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: çœ‹ä¸åˆ° "ç©å®¶å­˜æ¡£" æŒ‰é’®

**æ£€æŸ¥ï¼š**
```sql
-- ç¡®è®¤ç”¨æˆ·æ˜¯ç®¡ç†å‘˜
SELECT role FROM users WHERE id = <YOUR_USER_ID>;
-- åº”è¯¥è¿”å› 'admin'
```

**è§£å†³ï¼š**
```sql
-- å°†ç”¨æˆ·è®¾ç½®ä¸ºç®¡ç†å‘˜
UPDATE users SET role = 'admin' WHERE id = <YOUR_USER_ID>;
```

### é—®é¢˜2: APIè¿”å›403é”™è¯¯

**åŸå› ï¼š** 
- Tokenè¿‡æœŸæˆ–æ— æ•ˆ
- ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜

**è§£å†³ï¼š**
- é‡æ–°ç™»å½•è·å–æ–°token
- æ£€æŸ¥ç”¨æˆ·role

### é—®é¢˜3: åˆ é™¤å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- å°è¯•åˆ é™¤ç®¡ç†å‘˜è´¦å·
- æ•°æ®åº“è¿æ¥é—®é¢˜

**æ£€æŸ¥æ—¥å¿—ï¼š**
```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f server/logs/app.log
```

---

## æ€»ç»“

âœ… **å®Œæ•´çš„ç©å®¶å­˜æ¡£ç®¡ç†ç³»ç»Ÿ**  
âœ… **æœç´¢ã€æŸ¥çœ‹ã€åˆ é™¤ã€é‡ç½®åŠŸèƒ½**  
âœ… **æ‰¹é‡æ“ä½œæ”¯æŒ**  
âœ… **ç®¡ç†å‘˜æƒé™ä¿æŠ¤**  
âœ… **è¯¦ç»†çš„ç©å®¶æ•°æ®å±•ç¤º**  
âœ… **å®‰å…¨çš„åˆ é™¤æœºåˆ¶**  

**è®¿é—®æµç¨‹ï¼š**
ç™»å½•ç®¡ç†å‘˜è´¦å· â†’ è®¾ç½®é¢æ¿ â†’ ğŸ“ ç©å®¶å­˜æ¡£ â†’ ç®¡ç†ç•Œé¢

