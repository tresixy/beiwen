# 服务器资源配置评估

## 当前服务器配置

- **CPU**: 2核 (Intel Xeon Platinum 8255C @ 2.50GHz)
- **内存**: 3.6GB 总内存，2.1GB 可用
- **磁盘**: 59GB（已用8.1GB，可用49GB）
- **Swap**: 无

## 优化后的配置

- **PM2集群**: 2个进程（对应2核CPU）
- **数据库连接池**: 50个连接
- **PostgreSQL最大连接**: 100个（足够）
- **合成接口限流**: 已移除

## 资源使用评估

### ✅ 内存分析（良好）

**当前使用:**
- 系统 + PostgreSQL + Redis: ~1.3GB
- Node.js单进程: ~92MB

**预计使用（PM2集群后）:**
- PostgreSQL: ~30MB
- Redis: ~11MB  
- Node.js 2进程: ~200-400MB（每个进程100-200MB）
- 系统和其他: ~1GB
- **总计**: ~1.5-1.7GB
- **剩余**: ~1.9-2.1GB ✅ **充足**

**PM2内存限制**: 每个进程600MB（已调整）
- 2个进程最多使用: 1.2GB
- 加上其他服务: ~1.5GB
- **仍有约2GB余量** ✅

### ✅ CPU分析（合理）

- 2核CPU运行2个进程 ✅ **完美匹配**
- 预计CPU使用率: 50-80%（正常）
- 如果CPU满载，可以降级到1个进程

### ✅ 数据库连接（安全）

- PostgreSQL `max_connections`: 100
- 应用连接池: 50
- **余量充足** ✅

### ⚠️ 潜在风险

1. **无Swap空间**
   - 如果内存使用突然激增，可能OOM
   - **建议**: 监控内存使用，必要时添加Swap

2. **高并发时的内存压力**
   - 50人同时合成时，每个请求可能临时占用更多内存
   - **缓解**: PM2会自动重启超过600MB的进程

3. **AI合成时的外部API限制**
   - OpenAI API可能有速率限制
   - 这不是服务器配置问题，是外部服务限制

## 性能预期

### 正常情况（10-20人同时）
- ✅ CPU: 30-50%
- ✅ 内存: ~1.5GB
- ✅ 响应时间: <500ms

### 高并发情况（50人同时）
- ⚠️ CPU: 70-90%（可能满载）
- ⚠️ 内存: ~2-2.5GB（仍在安全范围）
- ⚠️ 响应时间: 500ms-2s（取决于AI API）

## 监控建议

### 1. 实时监控
```bash
# PM2监控
pm2 monit

# 系统资源
htop
# 或
watch -n 1 'free -h && echo --- && ps aux | grep node | grep -v grep'
```

### 2. 设置告警阈值
- **内存使用 > 3GB**: 警告
- **CPU使用 > 90%**: 警告
- **PM2进程重启频繁**: 检查内存泄漏

### 3. 日志监控
```bash
# PM2日志
pm2 logs minigame --lines 100

# 系统日志
dmesg | grep -i "out of memory"
```

## 优化建议

### 如果遇到内存不足

1. **降低PM2进程数**
   ```bash
   # 改为1个进程
   pm2 delete minigame
   pm2 start server/index.js --name minigame -i 1
   ```

2. **添加Swap空间**（推荐）
   ```bash
   # 创建2GB Swap
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   # 永久启用
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   ```

3. **降低数据库连接池**
   ```javascript
   // server/db/connection.js
   max: 30, // 从50降到30
   ```

### 如果遇到CPU满载

1. **减少PM2进程数到1个**
2. **优化代码性能**（减少CPU密集型操作）
3. **考虑升级CPU**（如果预算允许）

## 结论

✅ **当前配置可以支持优化后的设置**

- 内存: **充足**（有约2GB余量）
- CPU: **合理**（2核对2进程）
- 数据库: **安全**（连接数充足）

⚠️ **建议监控**

- 在高并发场景下监控内存和CPU
- 如果出现问题，可以降级到1个进程
- 考虑添加Swap空间作为安全缓冲

## 快速诊断命令

```bash
# 查看资源使用
free -h
pm2 list
pm2 monit

# 查看进程内存
ps aux | grep -E "node|postgres|redis" | awk '{print $2, $4, $6, $11}'

# 检查是否有OOM
dmesg | grep -i "out of memory"
```

