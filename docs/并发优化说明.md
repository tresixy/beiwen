# 并发优化说明

## 已完成的优化

### 1. ✅ 移除合成接口限流
- **文件**: `server/routes/synthesize.js`
- **变更**: 移除了 `synthesizeRateLimit` 中间件
- **影响**: 用户不再受每分钟10次的合成限制

### 2. ✅ 提升数据库连接池
- **文件**: `server/db/connection.js`
- **变更**: 连接池从 `max: 20` 提升到 `max: 50`
- **影响**: 可以同时处理50个数据库连接请求

### 3. ✅ 配置PM2集群模式
- **文件**: `ecosystem.config.js` (新建)
- **配置**: 2个进程（对应2核CPU）
- **影响**: 并发处理能力提升约2倍

## 应用更改

### 方式1: 安装PM2并使用集群模式（推荐）

```bash
# 1. 安装PM2
npm install -g pm2

# 2. 停止当前服务
./service.sh stop
# 或
pkill -f "node.*server/index.js"

# 3. 使用PM2启动（集群模式）
pm2 start ecosystem.config.js

# 4. 设置开机自启（可选）
pm2 startup
pm2 save

# 5. 查看状态
pm2 list
pm2 monit  # 实时监控
```

### 方式2: 使用service.sh脚本（自动检测PM2）

```bash
# 重启服务（会自动使用PM2集群模式）
./service.sh restart

# 查看状态
./service.sh status
```

### 方式3: 如果PM2未安装，仍使用单进程模式

```bash
# 重启服务
./service.sh restart
```

## 验证优化效果

### 检查PM2集群状态
```bash
pm2 list
# 应该看到2个 minigame 进程
```

### 检查数据库连接池
```bash
# 查看PostgreSQL连接数
psql -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE datname = 'minigame';"
```

### 监控资源使用
```bash
pm2 monit
# 查看CPU、内存使用情况
```

## 性能提升预期

- **并发处理能力**: 提升约2倍（2个进程）
- **数据库连接**: 从20提升到50
- **限流移除**: 无限制（注意：AI合成仍受外部API限制）

## 注意事项

1. **AI合成限制**: 如果使用AI合成，OpenAI API可能有速率限制
2. **内存使用**: 2个进程会使用更多内存（每个约100-200MB）
3. **数据库连接**: 确保PostgreSQL的 `max_connections` 配置足够（建议至少100）

## 回滚方法

如果需要回滚到单进程模式：

```bash
pm2 stop minigame
pm2 delete minigame
./service.sh start  # 会自动使用单进程模式
```

## 相关文件

- `ecosystem.config.js` - PM2集群配置
- `server/db/connection.js` - 数据库连接池配置
- `server/routes/synthesize.js` - 合成接口（已移除限流）
- `service.sh` - 服务管理脚本（已更新支持PM2）


