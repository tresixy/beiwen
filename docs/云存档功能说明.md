# 云存档功能说明

## 功能概述

玩家的所有游戏数据现在都会自动保存到云端服务器，支持跨设备游戏。使用相同的邮箱登录，就能在任何设备上继续游戏进度。

## 存档内容

以下玩家数据会自动同步到服务器：

### 1. 基础数据
- **资源**：食物、生产力、研究点数
- **回合数**：当前游戏回合
- **用户信息**：邮箱、用户名、创建时间

### 2. 游戏状态
- **手牌**：当前持有的所有卡牌
- **背包**：收集的物品
- **职业**：已选择的职业和历史记录
- **契约**：当前激活的社会契约
- **卡牌收藏**：已解锁的所有卡牌

### 3. 世界数据（如果使用世界功能）
- **地图**：世界地块信息
- **实体**：建筑和单位
- **项目**：宏伟工程进度

## 使用方式

### 首次使用

1. **登录**：输入您的邮箱地址
   - 如果是第一次使用该邮箱，系统会自动创建新账号
   - 账号创建后会自动初始化游戏数据

2. **开始游戏**：进入游戏后，所有操作都会自动同步

### 换设备继续游戏

1. 在新设备上打开游戏
2. 使用**相同的邮箱**登录
3. 游戏会自动加载云端存档
4. 继续之前的游戏进度

## 自动同步机制

游戏采用智能同步策略，平衡性能和数据安全：

### 实时同步
- **回合结束**：立即同步资源、回合数
- **契约选择**：立即保存契约状态
- **职业选择**：立即保存职业状态

### 防抖同步（3秒延迟）
- **手牌变化**：3秒内无新变化后自动保存
- 减少服务器请求，提升游戏流畅度

### 加载时机
- **登录后进入游戏**：自动从服务器加载最新数据
- 显示"正在加载游戏数据..."提示
- 加载完成后显示"游戏进度已从服务器加载"提示

## 离线模式

如果服务器连接失败，游戏会自动切换到**本地模式**：

- ⚠️ 显示"无法加载云存档，使用本地模式"警告
- 游戏可以正常进行，但数据仅保存在本地
- 数据不会跨设备同步
- 重新连接服务器后，可以手动同步（功能待实现）

## API接口

### 获取游戏状态
```bash
GET /api/game/state
Authorization: Bearer <token>
```

返回完整的游戏状态，包括资源、手牌、背包、职业等。

### 保存手牌
```bash
POST /api/game/hand
Authorization: Bearer <token>
Content-Type: application/json

{
  "hand": [
    {"id": "card-1", "name": "火焰", "type": "element", ...},
    ...
  ]
}
```

### 保存契约状态
```bash
POST /api/game/contract
Authorization: Bearer <token>
Content-Type: application/json

{
  "contract": {
    "id": "contract-1",
    "choices": [...],
    ...
  }
}
```

### 清空契约
```bash
DELETE /api/game/contract
Authorization: Bearer <token>
```

### 结束回合
```bash
POST /api/turn/end
Authorization: Bearer <token>
```

自动更新资源、回合数，并可能生成新的契约或职业选择。

## 数据库结构

### user_game_state 表
```sql
CREATE TABLE user_game_state (
    user_id INTEGER PRIMARY KEY,
    hand_json JSONB DEFAULT '[]',        -- 手牌数据
    contract_json JSONB DEFAULT NULL,    -- 契约数据
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### resources 表
```sql
CREATE TABLE resources (
    user_id INTEGER PRIMARY KEY,
    food INTEGER DEFAULT 0,
    production INTEGER DEFAULT 0,
    research INTEGER DEFAULT 0,
    turn INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 测试

运行测试脚本验证存档功能：

```bash
cd /root/minigame
./test-save-game.sh
```

测试流程：
1. 登录用户
2. 获取初始游戏状态
3. 保存手牌
4. 重新获取状态验证存档
5. 结束回合
6. 获取更新后的资源

## 注意事项

### 数据安全
- 所有API请求需要JWT Token认证
- Token有效期：7天
- Token存储在浏览器localStorage中

### 数据一致性
- 使用数据库事务确保数据一致性
- 回合结束等关键操作使用行锁防止并发问题
- 自动处理数据冲突

### 性能优化
- 手牌保存采用3秒防抖，减少请求
- 使用JSONB存储复杂数据，查询效率高
- 索引优化，确保快速查询

## 未来改进

- [ ] 断线重连自动同步
- [ ] 版本冲突检测和合并
- [ ] 存档历史记录（回滚功能）
- [ ] 多存档槽位
- [ ] 云端备份导出
- [ ] 数据统计和分析

## 故障排查

### 问题：登录后看不到之前的进度

**可能原因：**
1. 使用了不同的邮箱登录
2. 数据库迁移未执行
3. 服务器连接失败

**解决方法：**
1. 确认使用正确的邮箱
2. 检查数据库表是否存在：
   ```bash
   PGPASSWORD=postgres psql -h localhost -U postgres -d minigame -c "\dt user_game_state"
   ```
3. 检查服务器日志：
   ```bash
   tail -f /root/minigame/server.log
   ```

### 问题：手牌保存失败

**可能原因：**
1. Token过期
2. 网络连接问题
3. 手牌数据格式错误

**解决方法：**
1. 重新登录获取新Token
2. 检查网络连接
3. 查看浏览器控制台错误信息

## 技术栈

- **前端**：React + localStorage（Token存储）
- **后端**：Node.js + Express + PostgreSQL
- **认证**：JWT (JSON Web Token)
- **数据库**：PostgreSQL + JSONB
- **API**：RESTful API

## 相关文件

### 后端
- `server/services/gameStateService.js` - 游戏状态服务
- `server/routes/gameState.js` - API路由
- `server/db/migrations/add_user_game_state.sql` - 数据库迁移

### 前端
- `client/src/services/gameStateApi.js` - API客户端
- `client/src/hooks/useGameSimulation.js` - 游戏状态管理（已集成云同步）
- `client/src/components/game/GameShell.jsx` - 游戏主界面

### 测试
- `test-save-game.sh` - 功能测试脚本

