<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡ç‰Œæ•°æ®åº“ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            color: #fff;
            font-size: 2rem;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        select, input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
        }

        select option {
            background: #2a2a40;
            color: #fff;
        }

        table {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        thead {
            background: rgba(255, 255, 255, 0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: #fff;
            font-weight: 600;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-base {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .badge-user {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
        }

        .error {
            background: rgba(255, 59, 48, 0.2);
            border: 1px solid rgba(255, 59, 48, 0.5);
            color: #ff3b30;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e30 0%, #2a2a40 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        input[type="text"], textarea, select {
            width: 100%;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-delete {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .btn-edit {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 8px;
        }

        .form-group label {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ´ å¡ç‰Œæ•°æ®åº“ç®¡ç†</h1>
            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-label">åŸºç¡€å¡ç‰Œ</div>
                <div class="stat-value" id="baseCards">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç”¨æˆ·ç”Ÿæˆ</div>
                <div class="stat-value" id="userCards">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»è®¡</div>
                <div class="stat-value" id="totalCards">-</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="showCreateModal()">+ åˆ›å»ºæ–°å¡ç‰Œ</button>
            <button class="btn" onclick="triggerCsvUpload()">å¯¼å…¥ CSV</button>
            <input type="file" id="csvInput" accept=".csv" style="display: none;" />
            <select id="sourceFilter" onchange="loadCards()">
                <option value="">å…¨éƒ¨æ¥æº</option>
                <option value="base">åŸºç¡€å¡ç‰Œ</option>
                <option value="user_generated">ç”¨æˆ·ç”Ÿæˆ</option>
            </select>
            <select id="eraFilter" onchange="loadCards()">
                <option value="">å…¨éƒ¨æ—¶ä»£</option>
                <option value="ç”Ÿå­˜æ—¶ä»£">ç”Ÿå­˜æ—¶ä»£</option>
                <option value="åŸé‚¦æ—¶ä»£">åŸé‚¦æ—¶ä»£</option>
                <option value="åˆ†é‡æ—¶ä»£">åˆ†é‡æ—¶ä»£</option>
                <option value="å¸å›½æ—¶ä»£">å¸å›½æ—¶ä»£</option>
                <option value="ç†æ€§æ—¶ä»£">ç†æ€§æ—¶ä»£</option>
                <option value="ä¿¡ä»°æ—¶ä»£">ä¿¡ä»°æ—¶ä»£</option>
                <option value="å¯è’™æ—¶ä»£">å¯è’™æ—¶ä»£</option>
            </select>
        </div>

        <div id="loading" class="loading">åŠ è½½ä¸­...</div>

        <table id="cardsTable" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>åç§°</th>
                    <th>æ¥æº</th>
                    <th>ç±»å‹</th>
                    <th>å¡ç‰Œç±»å‹</th>
                    <th>ç¨€æœ‰åº¦</th>
                    <th>æ—¶ä»£</th>
                    <th>è§£é”æ¡ä»¶</th>
                    <th>æè¿°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="cardsBody"></tbody>
        </table>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">åˆ›å»ºæ–°å¡ç‰Œ</h2>
            <form id="cardForm" onsubmit="return handleSubmit(event)">
                <div class="form-group">
                    <label>åç§° *</label>
                    <input type="text" id="cardName" required>
                </div>
                <div class="form-group">
                    <label>ç±»å‹ *</label>
                    <input type="text" id="cardType" required placeholder="å¦‚: element, material, concept">
                </div>
                <div class="form-group">
                    <label>ç¨€æœ‰åº¦ *</label>
                    <select id="cardRarity" required>
                        <option value="common">common</option>
                        <option value="uncommon">uncommon</option>
                        <option value="rare">rare</option>
                        <option value="epic">epic</option>
                        <option value="legendary">legendary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¡ç‰Œç±»å‹</label>
                    <select id="cardCardType">
                        <option value="inspiration">çµæ„Ÿå¡</option>
                        <option value="key">é’¥åŒ™å¡</option>
                        <option value="reward">å¥–åŠ±å¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ—¶ä»£</label>
                    <select id="cardEra">
                        <option value="">æ— </option>
                        <option value="ç”Ÿå­˜æ—¶ä»£">ç”Ÿå­˜æ—¶ä»£</option>
                        <option value="åŸé‚¦æ—¶ä»£">åŸé‚¦æ—¶ä»£</option>
                        <option value="åˆ†é‡æ—¶ä»£">åˆ†é‡æ—¶ä»£</option>
                        <option value="å¸å›½æ—¶ä»£">å¸å›½æ—¶ä»£</option>
                        <option value="ç†æ€§æ—¶ä»£">ç†æ€§æ—¶ä»£</option>
                        <option value="ä¿¡ä»°æ—¶ä»£">ä¿¡ä»°æ—¶ä»£</option>
                        <option value="å¯è’™æ—¶ä»£">å¯è’™æ—¶ä»£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è§£é”æ¡ä»¶</label>
                    <input type="text" id="cardUnlockCondition" placeholder="å¦‚: å¯’å†·, branch:order">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="cardIsStarter">
                        åˆå§‹æ‰‹ç‰Œ
                    </label>
                    <label style="margin-left: 20px;">
                        <input type="checkbox" id="cardIsDecoy">
                        è¿·æƒ‘å¡
                    </label>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="cardDescription"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editingCardId = null;
        const CSV_HEADER_MAP = {
            'name': 'name',
            'åç§°': 'name',
            'card name': 'name',
            'type': 'type',
            'ç±»å‹': 'type',
            'rarity': 'rarity',
            'ç¨€æœ‰åº¦': 'rarity',
            'era': 'era',
            'æ—¶ä»£': 'era',
            'card_type': 'card_type',
            'å¡ç‰Œç±»å‹': 'card_type',
            'cardtype': 'card_type',
            'unlock_condition': 'unlock_condition',
            'è§£é”æ¡ä»¶': 'unlock_condition',
            'unlock': 'unlock_condition',
            'is_starter': 'is_starter',
            'starter': 'is_starter',
            'åˆå§‹æ‰‹ç‰Œ': 'is_starter',
            'is_decoy': 'is_decoy',
            'decoy': 'is_decoy',
            'è¿·æƒ‘å¡': 'is_decoy',
            'description': 'description',
            'æè¿°': 'description',
        };

        async function loadCards() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('cardsTable');
            const tbody = document.getElementById('cardsBody');
            const errorDiv = document.getElementById('error');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const sourceFilter = document.getElementById('sourceFilter').value;
                const eraFilter = document.getElementById('eraFilter').value;
                
                const params = new URLSearchParams({
                    page: '1',
                    limit: '100'
                });
                if (sourceFilter) params.append('source', sourceFilter);
                if (eraFilter) params.append('era', eraFilter);

                const response = await fetch(`/api/cards-database-public/?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                }

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('baseCards').textContent = data.stats.baseCards;
                document.getElementById('userCards').textContent = data.stats.userGeneratedCards;
                document.getElementById('totalCards').textContent = data.stats.baseCards + data.stats.userGeneratedCards;

                // æ¸²æŸ“è¡¨æ ¼
                const cardTypeNames = {
                    'key': 'é’¥åŒ™å¡',
                    'inspiration': 'çµæ„Ÿå¡',
                    'reward': 'å¥–åŠ±å¡'
                };

                tbody.innerHTML = data.cards.map(card => `
                    <tr>
                        <td>${card.id}</td>
                        <td><strong>${card.name}</strong></td>
                        <td><span class="badge ${card.is_base_card ? 'badge-base' : 'badge-user'}">${card.is_base_card ? 'åŸºç¡€' : 'ç”¨æˆ·'}</span></td>
                        <td>${card.type}</td>
                        <td>${cardTypeNames[card.card_type] || card.card_type || '-'}</td>
                        <td>${card.rarity}</td>
                        <td>${card.era || '-'}</td>
                        <td>${card.unlock_condition || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${card.attrs_json?.description || '-'}</td>
                        <td>
                            <button class="btn btn-edit" onclick="editCard(${card.id})">ç¼–è¾‘</button>
                            <button class="btn btn-delete" onclick="deleteCard(${card.id}, '${card.name.replace(/'/g, "\\'")}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');

                loading.style.display = 'none';
                table.style.display = 'table';
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        function showCreateModal() {
            editingCardId = null;
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°å¡ç‰Œ';
            document.getElementById('cardForm').reset();
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingCardId = null;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('cardName').value,
                type: document.getElementById('cardType').value,
                rarity: document.getElementById('cardRarity').value,
                card_type: document.getElementById('cardCardType').value,
                era: document.getElementById('cardEra').value || null,
                unlock_condition: document.getElementById('cardUnlockCondition').value || null,
                is_starter: document.getElementById('cardIsStarter').checked,
                is_decoy: document.getElementById('cardIsDecoy').checked,
                attrs_json: {
                    description: document.getElementById('cardDescription').value
                }
            };

            try {
                const url = editingCardId 
                    ? `/api/cards-database-public/${editingCardId}`
                    : '/api/cards-database-public/';
                
                const response = await fetch(url, {
                    method: editingCardId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ä¿å­˜å¤±è´¥');
                }

                alert(editingCardId ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ');
                closeModal();
                loadCards();
            } catch (err) {
                alert(err.message);
            }
        }

        async function editCard(id) {
            try {
                // ä»å½“å‰è¡¨æ ¼ä¸­æŸ¥æ‰¾å¡ç‰Œæ•°æ®
                const response = await fetch(`/api/cards-database-public/?page=1&limit=1000`);
                const data = await response.json();
                const card = data.cards.find(c => c.id === id);
                
                if (!card) {
                    alert('æœªæ‰¾åˆ°å¡ç‰Œ');
                    return;
                }

                // è®¾ç½®ç¼–è¾‘æ¨¡å¼
                editingCardId = id;
                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¡ç‰Œ';
                
                // å¡«å……è¡¨å•
                document.getElementById('cardName').value = card.name;
                document.getElementById('cardType').value = card.type;
                document.getElementById('cardRarity').value = card.rarity;
                document.getElementById('cardCardType').value = card.card_type || 'inspiration';
                document.getElementById('cardEra').value = card.era || '';
                document.getElementById('cardUnlockCondition').value = card.unlock_condition || '';
                document.getElementById('cardIsStarter').checked = card.is_starter || false;
                document.getElementById('cardIsDecoy').checked = card.is_decoy || false;
                document.getElementById('cardDescription').value = card.attrs_json?.description || '';
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('modal').classList.add('show');
            } catch (err) {
                alert('åŠ è½½å¡ç‰Œå¤±è´¥: ' + err.message);
            }
        }

        async function deleteCard(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¡ç‰Œ"${name}"å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/cards-database-public/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
                }

                alert('åˆ é™¤æˆåŠŸ');
                loadCards();
            } catch (err) {
                alert(err.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.addEventListener('DOMContentLoaded', loadCards);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        window.addEventListener('DOMContentLoaded', function() {
            const csvInput = document.getElementById('csvInput');
            if (csvInput) {
                csvInput.addEventListener('change', handleCsvUpload);
            }
        });

        function triggerCsvUpload() {
            const csvInput = document.getElementById('csvInput');
            if (csvInput) {
                csvInput.click();
            }
        }

        async function handleCsvUpload(event) {
            const input = event.target;
            const file = input.files && input.files[0];

            if (!file) {
                return;
            }

            try {
                const text = await file.text();
                const rows = parseCsv(text);

                if (rows.length < 2) {
                    throw new Error('CSV æ–‡ä»¶ç¼ºå°‘è¡¨å¤´æˆ–æ•°æ®');
                }

                const headers = rows[0].map(normalizeHeader);
                const cards = [];

                for (let i = 1; i < rows.length; i++) {
                    const rowNumber = i + 1;
                    const values = rows[i];

                    if (!values.some(value => value && value.trim() !== '')) {
                        continue;
                    }

                    const card = buildCardFromRow(headers, values, rowNumber);
                    if (card) {
                        cards.push(card);
                    }
                }

                if (cards.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å¡ç‰Œè®°å½•');
                }

                const response = await fetch('/api/cards-database-public/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cards })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'å¯¼å…¥å¤±è´¥');
                }

                let message = `å¯¼å…¥æˆåŠŸ ${result.imported} å¼ å¡ç‰Œ`;

                if (result.errors && result.errors.length) {
                    const preview = result.errors.slice(0, 5).map(err => {
                        const rowLabel = err.row ? `ç¬¬${err.row}è¡Œ` : 'æœªçŸ¥è¡Œ';
                        const nameLabel = err.name ? `ï¼ˆ${err.name}ï¼‰` : '';
                        return `${rowLabel}${nameLabel}: ${err.error}`;
                    });

                    message += `ï¼Œå¤±è´¥ ${result.errors.length} è¡Œ\n` + preview.join('\n');
                    if (result.errors.length > 5) {
                        message += '\n...';
                    }
                }

                alert(message);
                loadCards();
            } catch (err) {
                alert(err.message || 'å¯¼å…¥å¤±è´¥');
            } finally {
                input.value = '';
            }
        }

        function parseCsv(text) {
            const rows = [];
            let current = '';
            let row = [];
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];

                if (inQuotes) {
                    if (char === '"') {
                        if (text[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        row.push(current);
                        current = '';
                    } else if (char === '\n') {
                        row.push(current);
                        rows.push(row);
                        row = [];
                        current = '';
                    } else if (char === '\r') {
                        continue;
                    } else {
                        current += char;
                    }
                }
            }

            if (inQuotes) {
                throw new Error('CSV æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ç»“æŸå¼•å·');
            }

            row.push(current);
            rows.push(row);

            return rows
                .map(columns => columns.map(value => value.trim()))
                .filter(columns => columns.some(value => value !== ''));
        }

        function normalizeHeader(header) {
            if (!header) {
                return '';
            }

            const key = header.trim().toLowerCase();
            return CSV_HEADER_MAP[key] || '';
        }

        function buildCardFromRow(headers, values, rowNumber) {
            const record = {};

            headers.forEach((header, index) => {
                if (!header) {
                    return;
                }

                record[header] = values[index] ? values[index].trim() : '';
            });

            const required = ['name', 'type'];

            for (const key of required) {
                if (!record[key]) {
                    throw new Error(`ç¬¬${rowNumber}è¡Œç¼ºå°‘å¿…å¡«å­—æ®µ ${key}`);
                }
            }

            return {
                name: record.name,
                type: record.type,
                rarity: normalizeCsvRarity(record.rarity),
                card_type: record.card_type || 'inspiration',
                era: record.era || null,
                unlock_condition: record.unlock_condition || null,
                is_starter: parseCsvBoolean(record.is_starter),
                is_decoy: parseCsvBoolean(record.is_decoy),
                description: record.description || '',
                sourceRow: rowNumber,
            };
        }

        function parseCsvBoolean(value) {
            if (value === undefined || value === null) {
                return false;
            }

            if (typeof value === 'boolean') {
                return value;
            }

            const normalized = value.toString().trim().toLowerCase();

            if (!normalized) {
                return false;
            }

            if (['false', '0', 'no', 'n', 'å¦'].includes(normalized)) {
                return false;
            }

            return ['true', '1', 'yes', 'y', 'æ˜¯', 'åˆå§‹', 'starter', 't', 'on'].includes(normalized);
        }

        function normalizeCsvRarity(value) {
            if (value === undefined || value === null) {
                return 'common';
            }

            const text = value.toString().trim();
            if (!text) {
                return 'common';
            }

            return text.toLowerCase();
        }
    </script>
</body>
</html>

