# 运维指南

## 快速命令

### 服务管理

```bash
cd /root/minigame

# 启动服务
./service.sh start

# 停止服务
./service.sh stop

# 重启服务
./service.sh restart

# 查看状态
./service.sh status

# 查看日志
./service.sh logs

# 诊断并修复问题
./service.sh fix
```

## 常见问题排查

### 502 Bad Gateway

**症状：** 访问网站返回 502 错误

**原因：** 
- Node.js 服务未运行
- 服务崩溃
- 端口未正确监听

**解决方案：**
```bash
./service.sh fix
# 或
./fix-502.sh
```

### 查看错误日志

```bash
# 实时查看日志
tail -f logs/server.log

# 查看最后 50 行
tail -n 50 logs/server.log

# 搜索错误
grep -i error logs/server.log
```

### 手动重启服务

```bash
# 停止所有 Node.js 进程
pkill -f "node.*server/index.js"

# 删除 PID 文件
rm -f minigame.pid

# 重新启动
nohup npm start > logs/server.log 2>&1 &
echo $! > minigame.pid
```

### 检查端口占用

```bash
# 查看 3000 端口
lsof -i :3000

# 查看 80 端口（Nginx）
lsof -i :80
```

### 检查依赖服务

```bash
# PostgreSQL
sudo systemctl status postgresql
sudo systemctl start postgresql

# Redis
sudo systemctl status redis-server
sudo systemctl start redis-server

# Nginx
sudo systemctl status nginx
sudo systemctl restart nginx
```

## 服务架构

```
用户请求 → Nginx (80) → Node.js (3000) → PostgreSQL / Redis
```

- **Nginx**: 反向代理，监听 80 端口
- **Node.js**: 应用服务器，监听 3000 端口
- **PostgreSQL**: 主数据库
- **Redis**: 缓存和限流

## 环境变量

关键配置在 `.env` 文件：

```bash
PORT=3000
NODE_ENV=production
JWT_SECRET=你的密钥
DATABASE_URL=postgresql://...
REDIS_URL=redis://localhost:6379
```

## 数据库迁移

运行新的数据库迁移：

```bash
# 时代与events系统
node server/db/run-migration.js

# 用户生成卡牌系统
node server/db/run-migration-user-cards.js

# 创建管理员账号
node server/db/create-admin.js
```

## 性能监控

### 查看进程资源使用

```bash
# 查看所有 Node.js 进程
ps aux | grep node

# 查看特定进程
top -p $(cat minigame.pid)
```

### 查看磁盘使用

```bash
# 项目目录大小
du -sh /root/minigame

# 日志文件大小
du -sh logs/
```

### 清理日志

```bash
# 备份并清空日志
cp logs/server.log logs/server.log.$(date +%Y%m%d)
> logs/server.log
```

## 备份与恢复

### 数据库备份

```bash
# 备份数据库
pg_dump -U postgres minigame > backup_$(date +%Y%m%d).sql

# 恢复数据库
psql -U postgres minigame < backup_20250101.sql
```

### 完整备份

```bash
# 备份整个项目（排除 node_modules）
tar -czf minigame_backup_$(date +%Y%m%d).tar.gz \
  --exclude=node_modules \
  --exclude=logs \
  /root/minigame
```

## 安全更新

### 更新依赖

```bash
# 更新 Node.js 依赖
npm update

# 检查过时的包
npm outdated

# 检查安全漏洞
npm audit
npm audit fix
```

### 更新系统

```bash
# 更新系统包
sudo apt update
sudo apt upgrade -y

# 重启 Nginx
sudo systemctl restart nginx
```

## 监控告警

### 设置健康检查 Cron

```bash
# 编辑 crontab
crontab -e

# 添加每5分钟检查一次
*/5 * * * * /root/minigame/check-server.sh >> /root/minigame/logs/health-check.log 2>&1
```

### 邮件告警配置

需要配置邮件发送服务（如 postfix 或使用第三方服务）

## 自动重启配置

### 使用 PM2（推荐）

```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start server/index.js --name minigame

# 设置开机自启
pm2 startup
pm2 save

# 监控
pm2 monit

# 查看日志
pm2 logs minigame
```

### 使用 systemd

创建 `/etc/systemd/system/minigame.service`:

```ini
[Unit]
Description=Infinite Synthesis Game
After=network.target postgresql.service redis-server.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/minigame
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

启用服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable minigame
sudo systemctl start minigame
sudo systemctl status minigame
```

## 故障恢复流程

1. **确认问题**
   ```bash
   ./service.sh status
   ```

2. **查看日志**
   ```bash
   tail -n 100 logs/server.log
   ```

3. **尝试自动修复**
   ```bash
   ./service.sh fix
   ```

4. **手动排查**
   - 检查依赖服务（PostgreSQL, Redis）
   - 检查磁盘空间
   - 检查内存使用
   - 检查 Nginx 配置

5. **重启服务**
   ```bash
   ./service.sh restart
   ```

6. **验证恢复**
   ```bash
   curl http://localhost:3000/health
   curl http://43.161.234.121/
   ```

## 联系信息

- 服务器IP: 43.161.234.121
- 内网地址: http://localhost:3000
- Nginx 端口: 80
- Node.js 端口: 3000
- PostgreSQL 端口: 5432
- Redis 端口: 6379

## 紧急联系

如果以上方法无法解决问题，请：
1. 保存当前日志文件
2. 检查系统资源（CPU、内存、磁盘）
3. 联系系统管理员





