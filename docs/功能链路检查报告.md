# 功能链路检查报告

生成时间：2025-11-01

## 🔴 严重问题（核心功能断裂）

### 1. 合成系统与卡牌系统断裂 ⚠️ **最严重**

**问题描述：**
- 合成后的物品保存到 `items` 表，添加到背包（`inventories`）
- 抽牌系统从 `cards` 表和 `deck_cards` 表读取
- **合成的新物品没有自动转换为卡牌**，无法在后续回合被抽取

**影响：**
用户合成的新物品只是一次性消耗品，无法形成"合成-发现-再次使用"的循环玩法

**代码位置：**
- `server/routes/synthesize.js` (L102-117) - 只保存item和添加到背包
- `server/services/cardService.js` - 有 `createOrGetUserCard` 函数但未被调用

**修复方案：**
在 `synthesize.js` 合成成功后，调用 `cardService.createOrGetUserCard()` 将新物品也注册为卡牌

```javascript
// 在 synthesize.js L117 后添加
const cardData = {
  name: item.name,
  type: 'inspiration',
  rarity: ['common', 'uncommon', 'rare', 'epic', 'legendary'][Math.min(item.tier - 1, 4)] || 'common',
  era: currentEra,
  card_type: 'inspiration',
  attrs_json: item.attrs,
  source_type: 'user_generated',
};
await cardService.createOrGetUserCard(userId, cardData);
```

---

### 2. 登录系统无密码验证 ⚠️

**问题描述：**
`authService.login()` 只检查email，不验证密码

**代码位置：**
- `server/services/authService.js` (L69-146)
- `server/routes/auth.js` (L20-27)

**安全风险：**
任何人知道邮箱即可登录，严重安全漏洞

**修复方案：**
1. 修改 `loginSchema` 添加 `password` 字段验证
2. 在 `login()` 中添加密码验证：
```javascript
const passwordMatch = await argon2.verify(user.password_hash, password);
if (!passwordMatch) {
  throw new Error('Invalid password');
}
```

---

## 🟡 中等问题（功能不完整）

### 3. 时代推进缺失自动卡牌解锁

**问题描述：**
- `eventService.completeEvent()` 会更新时代（L183）
- 但未自动解锁新时代的初始卡牌

**影响：**
玩家进入新时代后，无法获得该时代的特色卡牌

**修复方案：**
在 `completeEvent()` 时代升级后，调用 `cardService.unlockEraCards(userId, newEra)`

---

### 4. 前端合成结果未正确映射

**问题描述：**
`client/src/hooks/useGameSimulation.js` (L313-319) 创建 resultCard 时：
- 使用 `TEST_FORGE_RESULT_NAME` 而不是 `data.item.name`
- 导致前端显示的卡牌名称与实际合成结果不符

**修复方案：**
```javascript
const resultCard = {
  id: `card-${Date.now()}`,
  name: data.item.name, // 使用实际名称
  type: data.item?.attrs?.type || '合成物',
  rarity: ...,
  attrs: data.item?.attrs,
};
```

---

### 5. 职业系统与时代系统未联动

**问题描述：**
- 职业系统有完整的实现（`professionService.js`）
- 时代系统也有完整实现（`eventService.js`）
- 但两者没有关联（某些时代应该解锁特定职业）

**建议：**
在时代升级时，根据时代解锁对应职业选项

---

## 🟢 轻微问题（体验优化）

### 6. 回合系统随机事件与Events系统混淆

**问题描述：**
- `turnService.js` 有简单的随机事件（每5回合）
- `eventService.js` 有完整的Events挑战系统
- 两者命名相似，容易混淆

**建议：**
将 `turnService` 中的随机事件重命名为 "turnEffects" 或 "periodicEffects"

---

### 7. 背包满时合成失败处理不友好

**问题描述：**
`synthesize.js` (L116) 背包满时只记录警告，不向用户反馈

**建议：**
返回提示信息：
```javascript
catch (err) {
  if (err.message === 'Inventory full') {
    return res.status(400).json({ 
      error: '背包已满', 
      item,
      suggestion: '请先清理背包' 
    });
  }
}
```

---

### 8. 管理员中间件在 cardsDatabase 路由中重复使用

**问题描述：**
- `routes/cardsDatabase.js` 使用 `authMiddleware + adminMiddleware`
- `routes/cardsDatabasePublic.js` 使用 `nginxAdminMiddleware`
- 两个路由功能几乎相同，维护成本高

**建议：**
统一使用一个路由，根据环境变量选择中间件

---

## ✅ 正常功能（已验证）

### 认证流程
- ✅ JWT生成和验证正常
- ✅ authMiddleware 正确验证token
- ⚠️ 登录无密码验证（见问题2）

### 游戏初始化
- ✅ 注册时初始化背包、资源、职业状态
- ✅ 初始化7张基础卡牌

### 卡牌系统
- ✅ 抽牌功能正常（从 deck_cards 抽取）
- ✅ 权重抽卡（根据稀有度）
- ⚠️ 合成不生成卡牌（见问题1）

### 合成系统
- ✅ 规则合成正常
- ✅ AI合成正常
- ✅ 时代限制检查正常
- ⚠️ 合成结果不进入卡牌池（见问题1）

### 背包系统
- ✅ 添加物品正常
- ✅ 移除物品正常
- ✅ 背包满时抛出错误

### 回合系统
- ✅ 结束回合正常
- ✅ 资源结算正常
- ✅ 随机事件触发正常
- ✅ 职业回合处理正常

### Events系统
- ✅ 事件序列生成正常
- ✅ 完成事件奖励正常
- ✅ 时代升级正常
- ⚠️ 奖励卡牌解锁正常，但新时代卡牌未自动解锁（见问题3）

### 世界系统
- ✅ 实体放置功能存在
- ✅ 世界状态查询正常
- ⚠️ 资源产出计算需要验证实际调用

### 管理员系统
- ✅ 权限验证正常
- ✅ 卡牌CRUD功能正常
- ✅ 用户生成卡牌保护机制存在

### 前后端通信
- ✅ API路由注册完整
- ✅ 错误处理统一
- ✅ 数据格式标准（JSON）
- ⚠️ 前端合成结果映射错误（见问题4）

---

## 📊 功能链路图

```
【完整游戏循环】
用户注册 ✅
  ↓
初始化资源/背包/卡牌 ✅
  ↓
抽牌 ✅
  ↓
选择卡牌合成 ✅
  ↓
合成生成物品 ✅
  ↓
物品加入背包 ✅
  ↓
[断裂] 物品未加入卡牌池 ❌
  ↓
无法在后续回合抽到合成物品 ❌

【修复后的循环】
合成生成物品 ✅
  ↓
物品加入背包 ✅
  ↓
同时注册为新卡牌 → deck_cards ✅
  ↓
后续回合可抽取 ✅
```

---

## 🔧 优先修复建议

1. **P0（立即修复）：** 问题1 - 合成系统与卡牌系统断裂
2. **P0（立即修复）：** 问题2 - 登录无密码验证
3. **P1（尽快修复）：** 问题3 - 时代推进卡牌解锁
4. **P1（尽快修复）：** 问题4 - 前端合成结果映射
5. **P2（择期优化）：** 问题5-8

---

## 📝 测试建议

修复问题1后，需要测试：
1. 合成新物品后，检查 `cards` 表是否有新记录
2. 检查 `deck_cards` 表是否关联到用户
3. 下次抽牌时，是否可能抽到合成的物品
4. 其他用户合成同名物品时，是否复用已有卡牌记录

---

生成工具：AI Code Review System





