# 卡牌管理使用指南

## 快速开始

### 1. 运行数据库迁移

首次使用前需要运行迁移，添加用户生成卡牌相关字段：

```bash
node server/db/run-migration-user-cards.js
```

### 2. 访问管理界面

**前提条件：** 用户角色必须是 `admin`

**访问路径：**
1. 登录游戏
2. 进入大厅
3. 点击右下角 ⚙️ 设置
4. 点击「🎴 卡牌数据库」按钮

或直接访问：`http://localhost:5001/cardsdatabase/`

## 界面说明

### 统计卡片

顶部显示三个统计卡片：
- **基础卡牌**：预设的初始卡牌数量（绿色标记）
- **用户生成**：玩家合成创建的卡牌数量（蓝色标记）
- **总计**：所有卡牌总数

### 筛选器

- **全部来源 / 基础卡牌 / 用户生成**：按卡牌来源筛选
- **全部时代 / 生存时代 / 城邦时代 / ...**：按时代筛选
- **全部类型 / 钥匙卡 / 灵感卡 / 奖励卡**：按卡牌类型筛选

### 卡牌列表

表格显示所有卡牌信息：

| 列名 | 说明 |
|------|------|
| ID | 卡牌唯一编号 |
| 名称 | 卡牌名称 |
| 来源 | 基础/用户（带颜色标记） |
| 创建者 | 用户生成卡牌的创建者用户名 |
| 类型 | 卡牌类型（如 element, material） |
| 稀有度 | common, uncommon, rare, epic, legendary |
| 时代 | 所属时代 |
| 卡牌类型 | key(钥匙卡), inspiration(灵感卡), reward(奖励卡) |
| 解锁条件 | 解锁该卡牌的条件 |
| 初始卡 | 是否为起始手牌 |
| 迷惑卡 | 是否为迷惑卡 |
| 描述 | 卡牌描述信息 |
| 操作 | 编辑 / 删除按钮 |

**行颜色：**
- 浅绿色背景 = 基础卡牌
- 浅蓝色背景 = 用户生成卡牌

## 功能操作

### 创建新卡牌

1. 点击「+ 创建新卡牌」按钮
2. 填写表单：
   - **名称** * （必填）：卡牌名称，必须唯一
   - **类型** * （必填）：如 element, material, concept
   - **稀有度** * （必填）：common ~ legendary
   - **时代**：所属时代（可选）
   - **卡牌类型**：key / inspiration / reward
   - **解锁条件**：如「寒冷」或「branch:order」
   - **初始手牌**：勾选则为起始卡牌
   - **迷惑卡**：勾选则为迷惑卡
   - **描述**：卡牌的描述信息
3. 点击「创建」

**注意：**
- 创建的卡牌会标记为基础卡牌（`is_base_card = TRUE`）
- 卡牌名称不能与已有卡牌重复

### 编辑卡牌

1. 点击卡牌行的「编辑」按钮
2. 修改需要更改的字段
3. 点击「保存」

**提示：**
- 可以编辑任何卡牌（包括用户生成的）
- 修改会立即生效，影响所有拥有该卡牌的用户

### 删除卡牌

1. 点击卡牌行的「删除」按钮
2. 确认删除操作

**保护机制：**
- 用户生成卡牌的删除按钮会被禁用
- 删除基础卡牌会影响所有拥有该卡牌的用户
- 如果卡牌被其他表引用（如 deck_cards），会提示"无法删除：该卡牌已被使用"

## 数据库结构

### cards 表核心字段

```sql
CREATE TABLE cards (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,  -- 卡牌名称（唯一）
  type VARCHAR(50) NOT NULL,          -- 类型
  rarity VARCHAR(20) DEFAULT 'common', -- 稀有度
  era VARCHAR(50),                    -- 时代
  card_type VARCHAR(20),              -- 卡牌类型
  
  -- 用户生成卡牌相关
  is_base_card BOOLEAN DEFAULT TRUE,  -- 是否为基础卡牌
  created_by_user_id INTEGER,         -- 创建者用户ID
  source_type VARCHAR(20) DEFAULT 'base', -- 来源类型
  
  -- 其他字段
  unlock_condition VARCHAR(100),      -- 解锁条件
  is_starter BOOLEAN DEFAULT FALSE,   -- 是否为初始卡
  is_decoy BOOLEAN DEFAULT FALSE,     -- 是否为迷惑卡
  attrs_json JSONB DEFAULT '{}',      -- 属性JSON
  created_at TIMESTAMP DEFAULT NOW()
);
```

### deck_cards 表（用户背包）

```sql
CREATE TABLE deck_cards (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  card_id INTEGER REFERENCES cards(id),  -- 引用 cards 表
  discovered BOOLEAN DEFAULT FALSE,
  count INTEGER DEFAULT 0,
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, card_id)
);
```

## 工作原理

### 用户合成新卡牌流程

```
用户合成卡牌
    ↓
检查 cards 表是否存在同名卡牌
    ↓
    ├─ 存在：使用已有卡牌ID
    └─ 不存在：创建新卡牌记录
        - is_base_card = FALSE
        - created_by_user_id = 用户ID
        - source_type = 'user_generated'
    ↓
添加到用户背包 (deck_cards)
    - 如果已有：count + 1
    - 如果没有：新建记录
```

### 优势

1. **唯一性**：每个独特卡牌只有一条记录
2. **共享性**：所有用户共享同一个卡牌池
3. **追溯性**：记录了用户生成卡牌的创建者
4. **性能**：背包只存ID引用，不重复存储数据
5. **扩展性**：为交易、图鉴等功能打下基础

## 常见问题

### Q1: 如何创建管理员账号？

```bash
node server/db/create-admin.js
```

### Q2: 用户生成的卡牌能删除吗？

界面上禁用了删除按钮作为保护，但技术上可以删除。删除后会影响所有拥有该卡牌的用户，需要谨慎操作。

### Q3: 如何确保用户只能使用已解锁时代的卡牌？

在合成逻辑中，通过以下方式限制：
1. 查询用户当前时代（`user_game_state.era`）
2. 只允许选择 `era <= 当前时代` 的卡牌
3. AI 合成时也会考虑时代限制

### Q4: 多个用户合成同名卡牌会怎样？

- 第一个用户：创建新卡牌记录
- 后续用户：复用已存在的卡牌记录
- 每个用户的背包都会记录该卡牌的拥有数量

### Q5: 如何批量导入卡牌？

使用「批量导入」接口：

```bash
curl -X POST http://localhost:5001/api/cards-database/batch \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "cards": [
      {
        "name": "新卡牌1",
        "type": "element",
        "rarity": "common",
        "era": "生存时代",
        "card_type": "inspiration",
        "attrs_json": {"description": "描述"}
      }
    ]
  }'
```

## 技术支持

- 详细技术文档：[用户生成卡牌系统](./用户生成卡牌系统.md)
- 时代系统文档：[时代与events系统](./时代与events系统.md)
- 主文档：[README.md](../README.md)


