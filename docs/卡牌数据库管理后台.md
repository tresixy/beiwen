# 卡牌数据库管理后台配置说明

## 访问地址

**URL**: `http://your-domain/cardsdatabase/`

- 通过 nginx 反向代理
- 不直接暴露 5001 端口
- 需要管理员密码验证

## 认证信息

- **用户名**: `aita`
- **密码**: `aita`

访问时浏览器会弹出 HTTP Basic Authentication 对话框，输入上述用户名和密码即可。

## 架构说明

```
用户浏览器
    ↓ (HTTP Basic Auth)
Nginx (端口 80) /cardsdatabase/
    ↓ (反向代理)
主游戏服务器 (localhost:3000) /api/cards-database/
    ↓
PostgreSQL 数据库
```

**注意**: 卡牌数据库 API 已集成到主游戏服务器中，无需单独启动服务。

## Nginx 配置

位置: `/etc/nginx/sites-available/minigame`

```nginx
# 卡牌数据库管理后台（需要密码验证）
location /cardsdatabase/ {
    # HTTP Basic Auth 认证
    auth_basic "Cards Database - Admin Only";
    auth_basic_user_file /etc/nginx/auth/.htpasswd_cards;
    
    # 反向代理到卡牌数据库服务
    proxy_pass http://localhost:5001/cardsdatabase/;
    proxy_http_version 1.1;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

## 密码文件

位置: `/etc/nginx/auth/.htpasswd_cards`

### 修改密码

```bash
# 修改现有用户密码
htpasswd /etc/nginx/auth/.htpasswd_cards aita

# 添加新用户
htpasswd /etc/nginx/auth/.htpasswd_cards newuser

# 删除用户
htpasswd -D /etc/nginx/auth/.htpasswd_cards username

# 重新加载 nginx 配置
systemctl reload nginx
```

## 安全特性

### 1. 端口隔离
- ✅ 5001 端口只监听 localhost，不对外开放
- ✅ 外部只能通过 nginx (80端口) 访问

### 2. 密码保护
- ✅ HTTP Basic Authentication
- ✅ 密码使用 Apache MD5 加密存储
- ✅ 需要正确的用户名和密码才能访问

### 3. 访问控制
- ✅ 只有管理员可以访问
- ✅ 所有访问都会记录到 nginx 日志

### 4. 日志记录

查看访问日志:
```bash
tail -f /var/log/nginx/minigame_access.log | grep cardsdatabase
```

查看错误日志:
```bash
tail -f /var/log/nginx/minigame_error.log
```

## 防火墙配置（可选）

如果使用防火墙，确保只开放 80/443 端口：

```bash
# 使用 ufw
ufw allow 80/tcp
ufw allow 443/tcp
ufw status

# 使用 iptables
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
iptables -A INPUT -p tcp --dport 5001 -j DROP  # 阻止外部访问 5001
```

## 测试访问

### 命令行测试

```bash
# 不带认证（会返回 401）
curl http://localhost/cardsdatabase/

# 带认证
curl -u aita:aita http://localhost/cardsdatabase/
```

### 浏览器测试

1. 打开浏览器访问: `http://localhost/cardsdatabase/`
2. 弹出认证对话框
3. 输入用户名: `aita`
4. 输入密码: `aita`
5. 成功访问管理后台

## 故障排除

### 问题1: 403 Forbidden

**原因**: 密码文件权限不正确

**解决**:
```bash
chmod 644 /etc/nginx/auth/.htpasswd_cards
chown www-data:www-data /etc/nginx/auth/.htpasswd_cards
systemctl reload nginx
```

### 问题2: 502 Bad Gateway

**原因**: 卡牌数据库服务未运行

**解决**:
```bash
# 检查 5001 端口是否在监听
netstat -tlnp | grep 5001

# 或使用 ss
ss -tlnp | grep 5001

# 启动卡牌数据库服务
# (根据实际服务启动方式)
```

### 问题3: 认证失败

**原因**: 用户名或密码错误

**解决**:
```bash
# 查看密码文件内容
cat /etc/nginx/auth/.htpasswd_cards

# 重新设置密码
htpasswd /etc/nginx/auth/.htpasswd_cards aita
systemctl reload nginx
```

### 问题4: 访问被拒绝

**检查**:
```bash
# 检查 nginx 配置
nginx -t

# 检查 nginx 状态
systemctl status nginx

# 查看错误日志
tail -50 /var/log/nginx/minigame_error.log
```

## 最佳实践

### 1. 使用强密码

虽然当前使用简单密码 `aita`，生产环境建议使用强密码：

```bash
# 使用随机强密码
htpasswd /etc/nginx/auth/.htpasswd_cards aita
# 然后输入强密码
```

### 2. 启用 HTTPS

如果有 SSL 证书，建议启用 HTTPS：

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # ... 其他配置 ...
}
```

### 3. IP 白名单（可选）

只允许特定 IP 访问：

```nginx
location /cardsdatabase/ {
    # 只允许特定 IP
    allow 192.168.1.100;
    allow 10.0.0.0/8;
    deny all;
    
    auth_basic "Cards Database - Admin Only";
    auth_basic_user_file /etc/nginx/auth/.htpasswd_cards;
    
    proxy_pass http://localhost:5001/cardsdatabase/;
    # ... 其他配置 ...
}
```

### 4. 定期审计

```bash
# 查看最近的访问记录
tail -100 /var/log/nginx/minigame_access.log | grep cardsdatabase

# 查看认证失败的尝试
grep "401" /var/log/nginx/minigame_access.log | grep cardsdatabase
```

## 维护命令

```bash
# 重新加载 nginx 配置（不中断服务）
systemctl reload nginx

# 重启 nginx 服务
systemctl restart nginx

# 查看 nginx 状态
systemctl status nginx

# 测试配置文件语法
nginx -t

# 查看当前认证用户
cat /etc/nginx/auth/.htpasswd_cards
```

## 相关文档

- [卡牌管理使用指南](./卡牌管理使用指南.md)
- [INSTALL_CARDS.md](../INSTALL_CARDS.md)
- [Nginx 官方文档](https://nginx.org/en/docs/)
- [HTTP Basic Authentication](https://tools.ietf.org/html/rfc7617)

---

**最后更新**: 2025-11-01  
**配置状态**: ✅ 已完成

